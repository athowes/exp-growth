---
title: "A generative model for qPCR data"
author: "Adam Howes"
bibliography: citations.bib
output:
  pdf_document:
    toc: yes
    number_sections: yes
  html_document:
    toc: yes
    df_print: paged
abstract: |
  The purpose of this document is to specify a generative model for qPCR data which captures
  a realistic data generating process sufficiently to outperform the "standard curve" simple
  linear regression approach. We anticipate the majority of the performance benefit will
  be when there are few initial virus copies, close to the limit of detection (LOD).
---

```{r echo = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  dpi = 320,
  out.width = "95%",
  fig.align = 'center'
)
```

\clearpage

# Introduction

<!-- * https://www.degruyter.com/document/doi/10.2202/1544-6115.1427/pdf -->
<!-- * https://sfamjournals.onlinelibrary.wiley.com/doi/epdf/10.1111/jam.14309 -->
<!-- * https://link.springer.com/content/pdf/10.1007/s00217-007-0683-z.pdf -->
<!-- * https://onlinelibrary.wiley.com/doi/epdf/10.1002/edn3.29 -->

## Background

<!-- https://www.thermofisher.com/content/dam/LifeTech/Documents/PDFs/PG1503-PJ9169-CO019879-Re-brand-Real-Time-PCR-Understanding-Ct-Value-Americas-FHR.pdf -->
<!-- https://www.gene-quantification.de/miqe-webinar-short-transcript.pdf -->

* Quantitative polymerase chain reaction (qPCR) is a technique used to detect and quantify DNA sequence concentration in a sample
* The target DNA sequence is amplified in cycles
* $C_q$ is the cycle number at which the amplification curve intersects some threshold line
* Many factors impact the absolute value of $C_q$ besides the concentration of the target DNA
* The amplification curve is determined by measuring fluorescence
* Rn is a measure of fluorescence, calculated as a ratio of the FAM dye to ROX dye
* $\Delta$Rn is Rn minus the baseline fluorescence
* Artefacts from the reaction mix or instrument can change the fluoresence measurements
* Fluorescence emission of any molecule depends on environmental factors (pH, salt concentration)

* Concentration factor
* Amount going in is unkown
* How many DNA are in a phagemid
* Use an electron microscope
* $10^8$ copies of DNA
* Accuracy of Nanodrop
* Phagemid particle
* Concentration in PFUs
* Experiment specific multiplicative units?
* Daisychain approach of having a relative standard

## The standard curve method

* Let $x$ be $\log_{10}(\text{copies per ml})$
* Carry out experiments for $x = 
* $C_q = a + b$
* Key relationship is that alterations of the number of copies by factors of ten should result in the same additive change in $C_q$

# Statistical model

<!-- [TODO: Let $i$ index the well position and add indexes for other relevant features (e.g. treatment)] -->

## Copy amplification

Suppose that there are initially $n_0 \in \mathbb{N}^+$ copies of the virus and the number of copies during amplification at cycle $c \in \mathbb{N}^+$ is $n_c$.
Amplification typically results in a logistic curve which may be described by parameteric models.
Two possible strategies for analysing this curve: (1) only model the exponential component, (2) model the complete curve [@ritz2008qpcr].

In the first strategy, the exponential component must be isolated by some method.
Onlt then, it can be modelled according to e.g.
$$
n_c = n_0 (1 + E)^c
$$
where the efficiency $E$ may have a prior centered at one.
We will not take this approach for the time being.
Note that the first derivative is
$$
\frac{\text{d}n_c}{\text{d}c} = n_0 \log(1 + E) (1 + E)^c
$$

Alternatively it is possible to model the complete curve.
We consider two possible models.
The four-parameter logistic model (4PL) is of the form
$$
n_c = n_\infty + \frac{n_0 - n_\infty}{\left(1 + (c / m)^b \right)}
$$
where $n_\infty = \lim_{t \to \infty} n_c$ is the asympotote of the curve at infinity, and $n_0 = \lim_{t \to 0} n_c$ is the estimated initial number of copies, $b$ is the slope and $m$ is the midpoint (see "[generalised logistic function](https://en.wikipedia.org/wiki/Generalised_logistic_function)").
The first derivative of $n_c$ is
$$
\frac{\text{d}n_c}{\text{d}c} = - (n_0 - n_{\inf}) \frac{1}{\left(1 + (c / m)^b \right)^2} b \frac{c^{b - 1}}{m^b}.
$$
Evaluating this at the midpoint, $m$, gives
$$
\frac{\text{d}n_c}{\text{d}c} \rvert_{c = m} = - (n_0 - n_{\inf}) \cdot \frac{b}{4m} = \frac{(n_{\inf} - n_0)}{4m} \cdot b,
$$
such that the derivative is proportional to the slope parameter $b$.
<!-- TODO: Connect this up to the efficiency $E$. -->
<!-- Next step is to answer in which section of the logistic curve does it look like the exponential? -->

The five-parameter logistic model (5PL) is similar to the four-parameter, but with an additional parameter $s$ which accounts for asymmetry of the curve
$$
n_c = n_\infty + \frac{n_0 - n_{\inf}}{\left(1 + (c / m)^b \right)^s}
$$

## Extension linking copies to fluorescence

The number of copies $n_c$ is connected to fluorescence data $f_t$ by some function $g$ such that $f_t \sim g(n_c)$.
For now, we will consider that this relationship is linear such that
$$
f_t = \beta_0 + \beta \cdot n_c 
$$
where $\beta_0$ is the background fluorescence and $\beta$ is the fluorescence produced by a single count.
The prior distributions $\beta_0 \sim p(\beta_0)$ and $\beta \sim p(\beta)$ may be determined by expert elicitation.

We observe $(f_0, \ldots, f_C)$ where $C$ is the total number of PCR cycles run.

## Extension to stochastic cycle times

Although each cycle is intended to run for one time step, it's possible this may not really be the case.
Instead, suppose that cycles $c = 1, \dots, C$ occur at times $t = t_1, \ldots, t_C$ with cycle time intervals $\kappa_c = t_{c + 1} - t_c$ between cycles.
A simple model for the intervals would be to have $\kappa_c \sim \mathcal{N}(\mu_\kappa, {\sigma_\kappa}^2)$.
The interval mean could be fixed to one or have a prior centered at one.
Cycle times are recovered via the cumulative sum of intervals $t_c = \sum_{d < c} \kappa_d$.

## Extension to processing and dilution

<!-- [TODO: Diagram of processing and dilution] -->

Prior to amplification, we might consider a processing step where e.g DNA is released from inside the phage capsid.
Suppose that a proportion $r$ of DNA are successfully released.
We assume that reducing the initial copies of the virus by a factor of 10 increased the midpoint $m$ by one unit.
One possible way to do this is to set $\log(r) \sim \mathcal{N}^{+}(0, 1)$, then altering the midpoint such that $m \leftarrow m + \log(r)$.
This approach isn't very mechanistic and won't give the desired zero inflated behaviour.
It also doesn't take into account losses from dilution.

\clearpage

# Implementation

We will build and expand our model step-by-step using the Stan probabilistic programming language via `rstan` [@rstan].
The primary aims of our analysis are:

1. To infer $N_0$ directly
2. To infer $C_q$, allowing a comparison against the value produced by default in-built software
3. To model multiple experiments jointly, eventually resulting in a posterior distribution over the standard curve which appropriately deals with the non-Gaussian uncertainty.
For example, a property we would like to confer is inflated errors at high $C_q$ values, corresponding to low initial numbers of copies.

## Model 1: copy amplification with link to fluorescence

We first start by considering a model including the 4PL logistic copy amplification component linearly linked to florescence data.
The Stan code for this model is given in Section \ref{sec:model1}.
We follow a Bayesian workflow [@gelman2020bayesian] by specifying a prior, generating data from that prior, then fitting the model to the generated data.
This may be done using one Stan file by including a parameter `flag_run_estimation`.

```{r fig.cap="Prior distribution with ten samples from the prior"}
knitr::include_graphics("4pl/prior-data.pdf")
```

```{r fig.cap="Prior distribution with ten samples from the prior, and posterior distribution fitted to one sample from the prior."}
knitr::include_graphics("4pl/prior-data-posterior.pdf")
```

<!-- TODO: Suppose that we know the threshold at which $C_q$ is measured by intersection with the amplification curve. -->

\clearpage

# Stan model files

## Model 1 \label{sec:model1}

```{stan, echo=TRUE, eval=FALSE, output.var="ex", code=readLines('4pl/4pl.stan')}
```

\clearpage

# Bibliography {-}
