---
title: "Poisson regression as an approach to exponential growth detection"
subtitle: "Nucleic Acid Observatory all-hands meeting"
date: "2022-08-24"
author: "Adam Howes"
bibliography: ../citations.bib
output:
  bookdown::html_document2:
    toc: yes
    toc_float: true
    toc_collapsed: true
    df_print: paged
    code_folding: hide
    theme: lumen
---

```{r setup, class.source = 'fold-hide'}
knitr::opts_chunk$set(
  echo = TRUE,
  cache = TRUE,
  autodep = TRUE,
  cache.comments = FALSE
)

options(scipen = 999)

cbpalette <- multi.utils::cbpalette()
```

```{r libraries, message=FALSE, class.source = 'fold-hide'}
library(tidyverse)
library(cowplot)
library(patchwork)
theme_set(theme_minimal())
```

# Background

* Any biological threat will necessarily undergo exponential growth
* Detecting exponential growth is a promising computational strategy for a threat-agnostic early warning system [@consortium2021global]
* OKR 1.4. is

> Develop an initial (computational) pipeline for exponential growth detection and execute it on simulated and spike-in metagenomic data

* This objective may be divided into a bioinformatics step and a statistics step
* The current output of the bioinformatics step is a collection of $k$-mer equivalence class time series
  * I'm just going to write $k$-mer rather than $k$-mer equivalence class
* Given these time series, we would like to infer which of them are in an exponential growth regime, using some hypothetical function `egd()`
* It will be computationally cheaper if `egd()` operates on each time-series independently
  * There is some structure in the data, so this may be losing some statistical power
  * An example of this structure is that we expect species to be increasing exponentially, and each species to have a number of $k$-mers which increase exponentially
* Possibly the simplest approach to exponential growth detection is Poisson regression

# What is Poisson regression, and how would it enable exponential growth detection

```{r poisson-plot, warning=FALSE, message=FALSE, fig.cap="The Poisson distribution."}
df <- data.frame(t = 1:14) %>%
  mutate(y = rpois(t, lambda = 10))

plot1 <- data.frame(x = 0:30) %>%
  mutate(y = dpois(x, lambda = 10)) %>%
  ggplot(aes(x = x, y = y)) +
    geom_col(fill = cbpalette[5], alpha = 0.7) +
    geom_dotplot(data = df, aes(x = y), fill = cbpalette[3], col = NA, inherit.aes = FALSE) +
    theme_minimal() +
    lims(y = c(0, 0.13)) +
    labs(x = "Number of copies observed", y = "Probability")

plot2 <- ggplot(df, aes(x = t, y = y)) +
  geom_point(col = cbpalette[3], size = 2.5) +
  theme_minimal() +
  geom_hline(yintercept = 10, linetype = "dashed") +
  labs(x = "Day", y = "Number of copies observed")

cowplot::plot_grid(plot1, plot2, ncol = 1)
```

* The Poisson distribution assumes events occur (1) at a constant rate, (2) independently
* We write $y \sim \text{Pois}(\lambda)$ to denote that $y$ follows a Poisson distribution with rate parameter $\lambda$
* If we expect to see a certain number of a particular $k$-mer per day, then the Poisson distribution is a good model for the randomness in how many $k$-mers we actually see
* Imagine that we have observations from 14 days $(y_1, y_2, \ldots, y_{14})$
* This type of data is called a time-series
* We can suppose the data point from each day $t$ is generated by a Poisson distribution with rate $\lambda_t$ so that $y_i \sim \text{Pois}(\lambda_t)$
* Explanation of Figure \@ref(fig:poisson-plot)
* To detect exponential growth we would prefer to be looking at the rate parameters $(\lambda_1, \lambda_2, \ldots, \lambda_{14})$, not the noisy observations
* The method we use to learn the rate parameters is called Poisson regression
* Poisson regression is similar to linear regression
* While in linear regression we would just fit a line to the data, in Poisson regression the line must be transformed so that it's always above zero, because rate parameters can be negative
* The way we do this is to use a link function which takes any number and returns a positive number, in particular the exponential function
* The result is a model that looks like $\lambda_t = \exp(\beta_0 + \beta t)$
  * $\beta_0$ is called the intercept
  * $\beta$ is called the slope
* We can use statistical algorithms to fit this model and obtain estimates for all the parameters
* This model is convenient, because to determine if a time-series looks to be exponentially growing we can just look at inference for the slope parameter
* By "inference" I mean: a point estimate $\hat \beta$, a (95%) confidence interval $\hat \beta \pm 1.96 \times \text{se}(\hat \beta)$, or a posterior distribution $p(\beta \, | \, y)$

# Is Poisson regression statistically suitable

```{r exponential-curves, fig.cap="Effects of changing the slope and intercept parameter on fitted line."}
beta_seq <- seq(-0.3, 0.3, length.out = 20)

df_beta <- expand_grid(t = 1:14, beta0 = 0, beta = beta_seq) %>%
  mutate(
    lambda = exp(beta0 + beta * t)
  )

plot3 <- ggplot(df_beta, aes(x = t, y = lambda, col = beta, group = beta)) +
  geom_line() +
  theme_minimal() +
  scale_color_continuous(type = "viridis") +
  labs(x = "Day", y = "Rate", col = "Slope", caption = "Intercept fixed to 0")

beta0_seq <- seq(-1, 1, length.out = 20)

df_beta0 <- expand_grid(t = 1:14, beta0 = beta0_seq, beta = 0.1) %>%
  mutate(
    lambda = exp(beta0 + beta * t)
  )

plot4 <- ggplot(df_beta0, aes(x = t, y = lambda, col = beta0, group = beta0)) +
  geom_line() +
  theme_minimal() +
  scale_color_continuous(type = "viridis") +
  labs(x = "Day", y = "Rate", col = "Intercept", caption = "Slope fixed to 0.1")

cowplot::plot_grid(plot3, plot4)
```

## Benefits

* Simplicity
* Takes into account randomness in observed $k$-mers
* Shown to work in easy situations
  * Add plot showing simulated baseline and exponential behaviour, and $p$-values from Poisson regression getting all of them right

## Concerns

* The model is not very flexible
  * If data looks to be increasing the only way available to the model to describe that is to change the slope parameter, but this necessitates either exponential growth or decay
  * A more flexible model might allow other patterns
  * Explanation of Figure \@ref(fig:exponential-curves)
* The model behaves strangely in some cases
  * If a new $k$-mer is observed after some number of days it's possible to perfectly fit the model through the data by putting the intercept $\beta_0$ as negative and the slope $\beta$ as positive
  * This issue can be remedied using regularisation -- in other words placing a prior on the intercept
  * Create a plot showing this problematic behaviour

# Is Poisson regression computationally suitable

* We have developed a script for running Poisson regression on a $k$-mer equivalence class table
* The $k$-mer equivalence class table looks like this
* The steps of the script are:
  1. Pivot the table
  2. Apply a Poisson regression model to each 14 rows of the pivoted table
  3. Use a function to tidy up the results
* Here is a table showing how long each of the above steps takes for 10, 100, 1000, 10000 rows ($k$-mer equivalence classes)
* At present this seems quite slow, but there are likely things that can be done to speed it up

# Conclusion

* Poisson regression is a reasonable first exponential growth detection approach, but there is a lot of room for iteration and improvement

## Bibliography {-}
